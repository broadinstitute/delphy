# File format for `.dphy` files

The `.dphy` files generated by the Delphy web interface encode periodic samples of the entire state of the MCMC run,
plus auxiliary information.  They are meant to allow the Delphy web interface to save and restore runs, as well as
easily sharing the results of a long run with others.

_WARNING_: The initial versions of this format are quite brittle: they started as a quick-and-dirty solution to help us
save and restore runs and to share them within the original development team, and only slowly became more established.
The format is essentially hard-coded against the only models available in Delphy's initial public release.  We expect
this format to evolve to something more flexible in the future, with significant changes in the process.  Thus, the
format is *not* suitable for long-term storage.  It would also be unwise to invest too much time in tools that
interoperate with this format directly.  While we expect to evolve the Delphy web interface to always be able to load
files in older format versions, we make no hard guarantees.

The format consists of consecutive elements of the following kinds:
* 32-bit integers (least-significant byte first, i.e., little-endian)
* 64-bit integers (also little-endian)
* 32-bit floating point numbers (IEEE 754, little-endian)
* A UTF-8 string, encoded as a 32-bit integer length L followed by exactly L bytes (no null terminator)
* A variable-sized [flatbuffer](https://flatbuffers.dev/), encoded as a 32-bit integer length N followed by exactly the
  N bytes that encode the flatbuffer contents.  We use the [flatbuffer schema
  format](https://flatbuffers.dev/flatbuffers_guide_writing_schema.html) to specify these buffers exactly.

## Header

- The first 4 bytes are always `'DPHY'`, i.e., `0x44`, `0x50`, `0x48`, `0x59`.
- The next 4 bytes are a 32-bit integer specifying a `.dphy` format version

The remainder of the file contents depend on the version number.  The earliest version we document is version 3.

## Version 3 format

- A UTF-8 string describing the core version, e.g. "0.996"
- A 32-bit integer encoding the core's build number (e.g., 2022)
- A UTF-8 string encoding the core commit, e.g., "33c06a8"
- A 32-bit integer encoding the "knee index", i.e., the index of the first sample past the burn-in region
- A 32-bit integer encoding the "steps per sample", e.g. 1_000_000
- A 32-bit integer specifying whether site-rate heterogeneity is enabled (1) or disabled (0)
- A 32-bit integer specifying whether modeling of APOBEC action (mpox) is enabled (1) or disabled (0)
- A 32-bit integer specifying whether the mutation rate is inferred (1) or fixed (0)
- A 32-bit float specifying the fixed mutation rate, only relevant when the mutation rate is fixed
- An "info" flatbuffer, described below
- A sequence of tree and parameter buffers, one per sample, encoded as follows:
  - A 32-bit integer encoding the length L_1 (never `0`) of the "tree" flatbuffer, described below.
  - A 32-bit integer encoding the length L_2 of the "params" flatbuffer, described below.
  - The raw L_1 bytes of the tree flatbuffer
  - The raw L_2 bytes of the params flatbuffer
- A sentinel 32-bit integer value of `0` to signal the end of the samples
- A UTF-8 JSON string encoding metadata and configuration options for the web interface, described below.
- A 64-bit integer specifying the location in the file of the above `0` sentinel value.  This value is meant to simplify
  extending a saved Delphy run in place, but as of this writing, none of our tooling uses it.

### Info flatbuffer

```
table TreeInfo {
  node_infos: [NodeInfo];     // Vector of 2N - 1 node infos, corresponding 1-1 with the nodes in the tree
}

table NodeInfo {
  name: string;               // From input data, e.g., FASTA IDs
}

root_type TreeInfo;
```

### Tree flatbuffer

```
// For unambiguous states
enum RealSeqLetter : uint8 { A, C, G, T }

struct Node {
  parent: int32;           // Range: [0, N-1), or -1 for the root node
  left_child: int32;       // Range: [0, 2N-1), or -1 for a tip.
  right_child: int32;      //   Note: A node has 0 or 2 children
  t: float32;              // Time: measured in fractional days since 2020-01-01
}

// NOTE: Branches below are identified by the end node, so branch `i` connects node `parent(i)` to node `i`.

// A mutation at time t, on branch `branch`, that changes the state at site `site` from `from` to `to`
struct Mutation {
  branch: int32;           // Branch on which this mutation lies
  site: int32;             // 0-based site: [0, L)
  from: RealSeqLetter;
  to: RealSeqLetter;
  t: float32;              // Time: measured in fractional days since 2020-01-01
}

// "Missation" = like a mutation, but denoting a (permanent) transition to ambiguity.
// In other words, a marker at the beginning of branch `branch`, specifying that at all
// points strictly below the start of the branch, the state of the given site is unknown ("missing").
// Since missations usually come in long contiguous gaps, we store them as a list of [start, end) intervals.
//
struct MissationInterval {
  branch: int32;           // Branch containing the missation interval
  start_site: int32;       // 0-based site: [0, L).  Inclusive.
  end_site: int32;         // 0-based site: [0, L).  Exclusive.
}

table Tree {
  nodes: [Node];              // Vector of 2N - 1 nodes, of which N-1 are inner nodes and N are tips
  mutations: [Mutation];      // Vector of M mutations, sorted ascending by branch, then site
  missation_intervals: [MissationInterval]; // Vector of missation intervals, sorted asc. by branch, then start_site
  ref_seq: [RealSeqLetter];   // Vector of states of L sites in reference sequence
  root_node: int32;
}

root_type Tree;
```

### Params flatbuffer

```
// Population models
// -----------------

table ExpPopModel {
  t0: float64    (id: 0); // Reference time t0 for population model [units: days since 2020-01-01]
  n0: float64    (id: 1); // Population model effective pop size at t = t0 [units of 1/day (it's obscure...), > 0]
  g: float64     (id: 2); // Population model growth rate [units of 1 / day, > 0]
}

enum SkygridType : byte {
  Staircase = 1,          // See pop_model.h, Skygrid_pop_model::Type::k_staircase
  LogLinear = 2           // See pop_model.h, Skygrid_pop_model::Type::k_log_linear
}

table SkygridPopModel {
  type: SkygridType = Staircase
                     (id: 0);
  x_k: [float64]     (id: 1);  // Times of M+1 knots [units: days since 2020-01-01, strictly increasing]
  gamma_k: [float64] (id: 2);  // gamma_k = ln(N(t_k)/(1 day)) [unitless]
}

union PopModel {
  ExpPopModel,
  SkygridPopModel
}


// Run parameters
// --------------

table Params {
  // Next free id: 38
  
  step: int64   (id:  0);      // MCMC steps taken so far [unitless, >= 0]
  num_local_moves_per_global_move: int64 = -1 (id: 1);  // [unitless, >= 1].  -1 => use reasonable default
  num_parts: int32   (id:  2); // Parallelism [unitless, >= 1]
  mu: float64        (id:  3); // Mutation rate [muts / site / day, > 0]
  alpha: float64     (id:  4); // Site rate heterogeneity parameter [unitless, > 0, never *too* far from 1.0, say 0.01 - 10.0]
  nu: [float64]      (id:  5); // Pointer to an array of L site relative rates [unitless, > 0, avg to 1.0]
  hky_kappa: float64 (id:  6); // Ratio of transition vs transversion exchangeabilities [unitless, > 0, typically 2 - 20]
  hky_pi_A: float64  (id:  7); // Stationary state frequency of A (should roughly match proportion of A's in root sequence)
  hky_pi_C: float64  (id:  8); // Stationary state frequency of C (should roughly match proportion of C's in root sequence)
  hky_pi_G: float64  (id:  9); // Stationary state frequency of G (should roughly match proportion of G's in root sequence)
  hky_pi_T: float64  (id: 10); // Stationary state frequency of T (should roughly match proportion of T's in root sequence)
  pop_model: PopModel (id: 30);// Population model type and parameters (union-type => uses up two ids)
  skygrid_tau: float64 (id: 31);// `tau` parameter of Skygrid model (if in use) [unitless, >= 0]
  skygrid_tau_prior_alpha: float64 (id: 32);// alpha parameter of Skygrid `tau` prior (if in use) [unitless, >= 0]
  skygrid_tau_prior_beta: float64 (id: 33);// beta parameter of Skygrid `tau` prior (if in use) [unitless, >= 0]
  skygrid_low_gamma_barrier_loc: float64 (id: 36);// value of gamma (log(N(t))) below which we penalize smaller populations [unitless, >= 0]
  skygrid_low_gamma_barrier_scale: float64 (id: 37);// value of gamma below low-gamma barrier loc at which barrier penalty reaches 1 nat (log(prior_barrier) = 1) [unitless, >= 0]

  // Deprecated hard-coded ExpPopModel parameters.  If pop_model is missing, assume exponential model with these
  // parameters; otherwise, ignore these
  pop_t0: float64    (id: 26); // Reference time t0 for population model [units: days since 2020-01-01]
  pop_n0: float64    (id: 11); // Population model effective pop size at t = t0 [units of 1/day (it's obscure...), > 0]
  pop_g: float64     (id: 12); // Population model growth rate [units of 1 / day, > 0]

  // Knobs
  only_displacing_inner_nodes: bool (id: 13);
  topology_moves_enabled: bool (id: 14);
  repartitioning_enabled: bool (id: 15);
  alpha_move_enabled: bool (id: 16);
  mu_move_enabled: bool = true (id: 25);
  final_pop_size_move_enabled: bool = true (id: 27);
  pop_growth_rate_move_enabled: bool = true (id: 28);
  skygrid_tau_move_enabled: bool = false (id: 34);
  skygrid_low_gamma_barrier_enabled: bool = false (id: 35);

  // Read-only (setting these has no effect)
  log_posterior: float64 (id: 17);
  log_other_priors: float64 (id: 18);
  log_coalescent_prior: float64 (id: 19);  // log_prior = log_G + log_coalescent_prior + log_other_priors
  log_G: float64 (id: 20);
  total_branch_length: float64 (id: 21);  // This can be derived easily from the tree itself: should we remove it from here?

  // Mpox hack
  mpox_hack_enabled: bool = false (id: 22);  // If true, use Andrew Rambaut's approximate APOBEC-aware model (see run.h)
  mpox_mu: float64 = 0.0 (id: 23);           // Rate of polymerase-induced mutations [muts/site/day, >0]
  mpox_mu_star: float64 = 0.0 (id: 24);      // Rate of APOBEC-induced TC->TT and GA->AA mutations [muts/site/day, >0]
}
```

### Metadata JSON

This string configures many internal knobs of the web interface and is especially brittle.  We only document
the JSON string that would be included by default in a simple run without metadata:

```
{
    "confidence":90,
    "topology":0,
    "presentation":0,
    "spacing":0,
    "colorBy":0,
    "burnin":0,
    "metadataPresent":0,
    "metadataText":null,
    "metadataFile":null,
    "metadataDelimiter":null,
    "selectedMDField":-1,
    "metadataColors":{}
}
```

Some of these fields refer to prototype features that we decided to drop during development:
- `confidence` specifies the threshold posterior support (as a percentage) for declaring an MCC node "well-supported"
  (e.g., highlighted in dark in MCCs, selectable when the selection filter is in place).
- `topology` should always be 1 to summarize the posterior distribution using an MCC.
- `presentation` should always be 1 to show all inner nodes in the MCC.
- `spacing` should be 0 to vertically space tips uniformly; setting it to 1 enables spacing by "SNP distance",
  which roughly tries to bring tips with close sequences much closer together.
- `burnin` is currently ignored and should be set to 0

The remaining options have to do with attached metadata:
- `metadataPresent` should be 1 if metadata is present, 0 otherwise.  Every other field below is ignored is
  `metadataPresent == 0`.
- `colorBy` should be 0 to color by confidence (MCC posterior support) or 1 to color by metadata
- `metadataFile` is a string with the name of the metadata files (for displaying in the Customize tab)
- `metadataText` is the contents of the metadata file, verbatim
- `metadataDelimiter` should be `","` or `"\t"` depending on whether the file is a csv or a tsv.
- `selectedMDField` is the 0-based index of the metadata column used to color the tree.
- `metadataColors` is a free-form dictionary with:
   - Key: metadata column name (string)
   - Value: a free-form dictionary with:
     - Key: metadata value (string); the special value `"-"` means "undefined"
     - Value: an object with these fields:
       - `color`: A web color specification, e.g., `#00a2ff`
       - `active`: A boolean of whether nodes with this value are colored or not

For example, adding a simple metadata file like this one in the UI:
```
id,Geo,Clade
EPI_ISL_123,Europe,A.1.2
EPI_ISL_456,Asia,B.2.3
```
could result in a metadata JSON string as follows:
```
{
    "confidence":90,
    "topology":0,
    "presentation":0,
    "spacing":0,
    "burnin":0,
    "metadataPresent":1,
    "colorBy":1,
    "metadataFile":"test_metadata.csv",
    "metadataText":"id,Geo,Clade\nEPI_ISL_123,Europe,A.1.2\nEPI_ISL_456,Asia,B.2.3",
    "metadataDelimiter":",",
    "selectedMDField":1,
    "metadataColors":{
      "Geo": {
        "Europe": {
          "color": "#112233",
          "active": true
        },
        "Europe": {
          "color": "#445566",
          "active": true
        },
        "-": {
          "color": "#778899",
          "active": true
        }
      }
    }
}
```
